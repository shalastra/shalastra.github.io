<!doctype html><html lang=en-us data-theme=dark><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Copy CSV to Postgres database inside Docker - Szymon Halastra</title><meta name=description content="Trying to merge urban science with programming"><link rel=icon type=image/x-icon href=https://shalastra.github.io/favicon.ico><link rel=apple-touch-icon-precomposed href=https://shalastra.github.io/favicon.png><link rel=stylesheet href="https://shalastra.github.io/css/light.css?rnd=1600800505"><style>:root{--font-color: #eee;--bg-color: #212121;--link-color:#599ada;--link-state-color:#ff5858;--link-state-border-color: rgba(238, 54, 54, 0.5);--thead-bg-color: #343a40;--table-border-color: lightgrey;--pre-color: #333;--pre-bg-color: #f1f1f1;--bq-color: #ccc;--hr-color: #333;--pagination-bg-color: #373737;--pagination-link-color: #b6b6b6;--post-info-color: grey;--switcher-color: #333;--switcher-bg-color: #fff}</style><link rel=stylesheet href="https://shalastra.github.io/css/style.css?rnd=1600800505"><meta property="og:title" content="Copy CSV to Postgres database inside Docker"><meta property="og:description" content="With Docker containers, it is easier to run services like databases without installing them locally. But how to populate the database with raw data in the CSV file?"><meta property="og:type" content="article"><meta property="og:url" content="https://shalastra.github.io/posts/postgres-docker/"><meta property="article:published_time" content="2020-05-02T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Copy CSV to Postgres database inside Docker"><meta name=twitter:description content="With Docker containers, it is easier to run services like databases without installing them locally. But how to populate the database with raw data in the CSV file?"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-165333027-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><h1 class=site-title><a href=/>Szymon Halastra</a></h1><nav><a href=https://shalastra.github.io/posts/>Posts</a>
<a href=https://shalastra.github.io/about/>About</a></nav></header><main id=main tabindex=-1><article class=post><header class=post-header><h1 class=post-title>Copy CSV to Postgres database inside Docker</h1></header><div class=content><p><img src=/img/docker_postgres.png alt=docker-postgres></p><p>With Docker containers, it is easier to run services like databases without installing them locally. But how to populate the database with raw data in the CSV file?</p><p>In this article, I want to explain that. Let&rsquo;s start with the project structure.</p><h2 id=project-structure>Project structure</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>data/
  datasource.csv
db/
  scripts/
    1_init.sql
    2_copy.sql
  Dockerfile
docker-compose.yml</code></pre></div><p><code>Dockerfile</code> uses postgres image and copies all *.sql files to /docker-entrypoint-initdb.d/. Later, all files are executed in alphanumerical order, that&rsquo;s why *.sql files start with digits. Finally, the port 6666 is exposed.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> postgres:alpine</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> *.sql /docker-entrypoint-initdb.d/<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> scripts/1_init.sql /docker-entrypoint-initdb.d<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> scripts/2_copy.sql /docker-entrypoint-initdb.d<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod a+r /docker-entrypoint-initdb.d/*<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 6666</span></code></pre></div><p><code>1_init.sql</code> creates the DB table, it has to have the same column names as in CSV file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>table_name</span> 
(    
   <span style=color:#75715e>--statement body 
</span><span style=color:#75715e></span>);</code></pre></div><p><code>2_copy.sql</code> is responsible for copying data from the CSV to postgres.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=color:#66d9ef>COPY</span> <span style=color:#66d9ef>table_name</span> <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#39;/data/datasource.csv&#39;</span> <span style=color:#66d9ef>DELIMITER</span> <span style=color:#e6db74>&#39;,&#39;</span> CSV HEADER;</code></pre></div><p>CSV the file is located in data folder inside of the project.
docker-compose.yml builds the Dockerfile from db folder and make it accessible through 5431port. As environmental properties basic postgres properties are used. And at the end data folder with CSV file is copied to the container.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker>version: <span style=color:#e6db74>&#39;3.3&#39;</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>services:<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span> db: <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>   build: ./db  <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>   container_name: postgres    <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>   ports:     <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    - <span style=color:#e6db74>&#34;5431:6666&#34;</span> <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>   environment: <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    - POSTGRES_USER<span style=color:#f92672>=</span>postgres  <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    - POSTGRES_PASSWORD<span style=color:#f92672>=</span>postgres <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    - POSTGRES_DB<span style=color:#f92672>=</span>db_name  <span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>   volumes:<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>   - ./data:/data</code></pre></div><p>Only thing left is to run <code>docker-compose</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker-compose up -d</code></pre></div></div><div class=post-info><div class=post-date>2020-05-02</div><div class=post-taxonomies><ul class=post-categories><li><a href=https://shalastra.github.io/categories/>Docker</a></li><li><a href=https://shalastra.github.io/categories/>Postgres</a></li></ul><ul class=post-tags><li><a href=https://shalastra.github.io/tags/docker>#docker</a></li><li><a href=https://shalastra.github.io/tags/postgres>#postgres</a></li></ul></div></div></article></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>© Szymon Halastra, 2020<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.</p></div></div></footer></div></body></html>